<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <title>2020 Tournament Matches</title>
  </head>
  <body>
    <style>
        .game-link, .game-link:visited, .game-link:hover {
            color: black;
            text-decoration: none;
        }

        #navToggle > ul > li > a {
            color: black;
            text-decoration: none;
        }
    </style>

    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <span class="navbar-brand">
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navToggle" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <span class="navbar-brand mb-0 h1">CTF Stats</span>
            </span>
            <span>
                <ul class="navbar-nav d-none d-lg-flex">
                    <li class="navbar-link">
                        <a class="nav-link" href="leaderboards.html">Leaderboards</a>
                    </li>
                    <li class="navbar-link">
                        <a class="nav-link" href="#">2020 Tournament</a>
                    </li>
                </ul>
            </span>
        </nav>
        <div class="collapse w-100" id="navToggle" style="z-index: 300; position: absolute;">
            <ul class="list-group">
                <li class="list-group-item rounded-0 border-1">
                    <a class="nav-link" href="leaderboards.html">Leaderboards</a>
                </li>
                <li class="list-group-item rounded-0 border-1">
                    <a class="nav-link" href="#">2020 Tournament</a>
                </li>
            </ul>
        </div>
    </header>

    <main role="main">
        <section class="jumbotron text-center mx-0">
            <div class="container">
              <h1>2020 CTF Teams Tournament</h1>
              <p class="lead text-muted">
                  Map names link to the corresponding game stats. MVP given by CTF Match Spotlight.
                  <br />
                  Watch the streams <a target="blank" href="https://www.youtube.com/playlist?list=PLCjuBMqh0PAloVqwImichuEK1zsAJidEL">here</a>.

              </p>
            </div>
        </section>
        <div class="container-fluid">
            <div class="row py-2">
                <div class="col-sm-3"></div>
                <div class="col-sm-6 justify-content-center">
                    <h3>Group Stage</h3>
                </div>
                <div class="col-sm-3"></div>
            </div>
            
            <div id="group-stage">

            </div>
        </div>
    </main>

    <footer class="footer bg-dark mt-3 py-3">
        <div class="container-fluid">
            <span class="text-light pl-4">Made by 915</span>
        </div>
    </footer>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@16/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <script type="text/babel" src="tourney-components.js"></script>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-firestore.js"></script>

    <script type="text/babel">
    function CardRow(match) {
    return (
        <div class="row py-2">
            <div class="col-sm-3"></div>
            <div class="col-sm">
                {Match(match)}
            </div>
            <div class="col-sm-3"></div>
        </div>
    );
}

function Match(match) {
    return (
        <div class={"card " + ((match.conference == "red") ? "bg-danger" : (match.conference == "blue") ? "bg-info" : "")} style={{color: "white"}}>
            <div class="card-body" data-toggle="collapse" data-target={"#card-content-" + match.uuid}>
                <h4 class="card-title">
                    <span class="d-none d-lg-inline badge badge-pill badge-light align-middle">{match.team1.sym}</span>
                    {" " + match.team1.name + " vs. " + match.team2.name + " "}
                    <span class="d-none d-lg-inline badge badge-pill badge-light align-middle">{match.team2.sym}</span>
                </h4>
                <div class="row d-flex justify-content-between px-3">
                    {Scores(match.team1, match.team2, match.maps)}
                    {MVPPills([match.team1.mvp, match.team2.mvp])}
                </div>
            </div>

            {CardContent(match.uuid, match.team1, match.team2, match.maps)}
        </div>
    );
}

Array.prototype.last = function() { return this[this.length - 1]; }

/**
 * Shows map scores
 * @param {Team} team1 
 * @param {Team} team2 
 * @param {Array<Map>} maps 
 */
function Scores(team1, team2, maps) {
    const scores = maps.map(map => 
        <span>
            <span class="badge badge-pill badge-light">{map.team1Caps.length + "-" + map.team2Caps.length}</span>
            {((map.id == maps.last().id) ? null : " / ")}
        </span>
    );

    // console.log(maps.map(map => [map.team1Score, map.team2Score]))
    // console.log(scores)

    return (
        <span class="scores">
            {scores}
        </span>
    );
}

/**
 * Shows the MVPs
 * @param {Array<string>} names Names to display
 */
function MVPPills(names) {
    // console.log("Generating mvps: " + names )
    const mvps = names.map(name => MVP(name));
    // console.log(mvps);
    return (
        <span class="mvps">
            <b class="d-none d-lg-inline">MVP:&nbsp;</b> 
            {mvps}
        </span>
    );
}

function MVP(name) {
    return (
        <span>
            <span class="badge badge-pill bg-dark">
                <img src={"http://cravatar.eu/avatar/" + name + "/15.png"} />&nbsp;
                {name}
            </span>&nbsp;
        </span>
    );
}

/**
 * Collapsable card content for match details
 * @param {string} id unique identifier for the card collapsing
 * @param {Team} team1 Team object 1
 * @param {Team} team2 Team object 2
 * @param {Array<Map>} maps List of maps for the match
 */
function CardContent(id, team1, team2, maps) {
    // console.log("Generating card content for card " + id);
    // console.log(maps.length + " maps found");
    return (
        <div class="collapse bg-white" id={"card-content-" + id} style={{color: "black"}}>
            <ul class="list-group list-group-flush">
                {DisplayHeader(team1, team2)}
                {DisplayMaps(maps)}
            </ul>
        </div>
    );
}

function DisplayHeader(team1, team2) {
    return (
        <li class="list-group-item">
            <div class="row">
                <div class="col">
                    <b>Map</b>
                </div>
                <div class="col">
                    <b>{team1.sym} Caps</b>
                </div>
                <div class="col">
                    <b>{team2.sym} Caps</b>
                </div>
            </div>
        </li>
    );
}

function DisplayMaps(maps) {
    return maps.map(map => MapDisplay(map));
}

/**
 * Shows single map performance in a row
 * @param {Map} map 
 */
function MapDisplay(map) {
    // console.log("Displaying map " + map.name);
    return (
        <li class="list-group-item">
            <div class="row">
                <div class="col">
                    <a class="game-link" target="blank" href={"https://www.brawl.com/games/ctf/lookup/" + map.id}>{map.name}</a>
                </div>
                <div class="col">
                    <div class="d-flex flex-column">
                        {map.team1Caps.map(cap => Player(cap.name, cap.time, true))}
                    </div>
                </div>
                <div class="col">
                    <div class="d-flex flex-column">
                        {map.team2Caps.map(cap => Player(cap.name, cap.time, true))}
                    </div>
                </div>
            </div>
        </li>
    );
}

/**
 * Shows player head next to name with optional time
 * @param {string} player Name of the player to display
 * @param {string} time (Optional) timestamp to include for caps
 */
function Player(player, time=null, collapse=false) {
    return (
        <span class="player">
            {(time == null) ? null : <span style={{fontFamily: 'monospace'}}>({time})</span>} <img src={"http://cravatar.eu/avatar/" + player + "/15.png"} /> <p class={(collapse) ? "d-none d-lg-inline" : ""}>{player}</p>
        </span>
    );
}
</script>

    <script>
        var firebaseConfig = {
          apiKey: "AIzaSyB7vvhOMxzYGeAK7-eMcJIJUQ5sNQQOkIs",
          authDomain: "ctf-stats-7f71d.firebaseapp.com",
          databaseURL: "https://ctf-stats-7f71d.firebaseio.com",
          projectId: "ctf-stats-7f71d",
          storageBucket: "ctf-stats-7f71d.appspot.com",
          messagingSenderId: "532957757645",
          appId: "1:532957757645:web:14ecfda2b2f9c396cb2984",
          measurementId: "G-928WMRV0RS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        async function getGroupStageMatches(){
            let res = await firebase.firestore()
                .collection("tournament")
                .doc("CTF2020")
                .collection("group-stage")
                .get()
            return res.docs.map(doc => doc.data());
        }
    </script>

    <script type="text/babel">
        getGroupStageMatches().then(result => {
            ReactDOM.render(<div>{result.sort((match1, match2) => {
                if (match1.time > match2.time) return -1;
                else if (match1.time < match2.time) return 1;
                else return 0;
            }).map(match => CardRow(match))}</div>, document.querySelector("#group-stage"));
        })

    </script>
  </body>
</html>